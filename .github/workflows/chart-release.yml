name: Release Helm Chart

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
    paths:
      - 'charts/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed to push to gh-pages branch

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # chart-releaser needs full history to determine versions

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Bootstrap gh-pages branch if missing
        run: |
          if ! git ls-remote --exit-code origin gh-pages; then
            git checkout --orphan gh-pages
            git rm -rf .
            {
              echo "theme: jekyll-theme-tactile"
              echo "title: Cloudflare Zero Trust Operator"
              echo "description: Helm chart repository for the Cloudflare Zero Trust Operator"
            } > _config.yml
            {
              echo "## Cloudflare Zero Trust Operator"
              echo ""
              echo "A Kubernetes operator that manages Cloudflare Zero Trust tunnel routing by watching HTTPRoute resources and reconciling them with the Cloudflare API."
              echo ""
              echo "### Install via Helm"
              echo ""
              echo '```bash'
              echo "helm repo add wheetazlab https://wheetazlab.github.io/cloudflare-zero-trust-operator"
              echo "helm repo update"
              echo "helm install cloudflare-zero-trust-operator wheetazlab/cloudflare-zero-trust-operator \\"
              echo "  --set tenant.create=true \\"
              echo "  --set tenant.instanceName=mycluster \\"
              echo "  --set tenant.accountId=<your-account-id> \\"
              echo "  --set tenant.tunnelId=<your-tunnel-id> \\"
              echo "  --set tenant.apiToken=<your-api-token>"
              echo '```'
              echo ""
              echo "### Source"
              echo ""
              echo "[github.com/wheetazlab/cloudflare-zero-trust-operator](https://github.com/wheetazlab/cloudflare-zero-trust-operator)"
            } > index.md
            git add _config.yml index.md
            git commit -m "chore: init gh-pages with Tactile theme and landing page"
            git push origin gh-pages
            git checkout main
          fi

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Ensure Tactile theme and landing page on gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          {
            echo "theme: jekyll-theme-tactile"
            echo "title: Cloudflare Zero Trust Operator"
            echo "description: Helm chart repository for the Cloudflare Zero Trust Operator"
          } > _config.yml
          {
            echo "## Cloudflare Zero Trust Operator"
            echo ""
            echo "A Kubernetes operator that manages Cloudflare Zero Trust tunnel routing by watching HTTPRoute resources and reconciling them with the Cloudflare API."
            echo ""
            echo "### Install via Helm"
            echo ""
            echo '```bash'
            echo "helm repo add wheetazlab https://wheetazlab.github.io/cloudflare-zero-trust-operator"
            echo "helm repo update"
            echo "helm install cloudflare-zero-trust-operator wheetazlab/cloudflare-zero-trust-operator \\"
            echo "  --set tenant.create=true \\"
            echo "  --set tenant.instanceName=mycluster \\"
            echo "  --set tenant.accountId=<your-account-id> \\"
            echo "  --set tenant.tunnelId=<your-tunnel-id> \\"
            echo "  --set tenant.apiToken=<your-api-token>"
            echo '```'
            echo ""
            echo "### Source"
            echo ""
            echo "[github.com/wheetazlab/cloudflare-zero-trust-operator](https://github.com/wheetazlab/cloudflare-zero-trust-operator)"
          } > index.md
          git add _config.yml index.md
          git diff --cached --quiet || git commit -m "chore: ensure Tactile theme and landing page [skip ci]"
          git push origin gh-pages
