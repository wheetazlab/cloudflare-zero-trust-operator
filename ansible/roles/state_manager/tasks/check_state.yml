---
# Check if IngressRoute needs reconciliation based on state
# Inputs:
#   - ingressroute: The IngressRoute object
#   - operator_namespace: Namespace where operator runs (default: cloudflare-zero-trust)
# Outputs:
#   - needs_reconciliation: Boolean - true if reconciliation needed
#   - state_configmap_name: Name of the state ConfigMap
#   - stored_annotation_hash: Previous annotation hash (if exists)

- name: Extract IngressRoute metadata
  ansible.builtin.set_fact:
    ir_name: "{{ ingressroute.metadata.name }}"
    ir_namespace: "{{ ingressroute.metadata.namespace }}"
    ir_uid: "{{ ingressroute.metadata.uid }}"

- name: Generate ConfigMap name for state tracking
  ansible.builtin.set_fact:
    state_configmap_name: "cfzt-{{ ir_namespace }}-{{ ir_name }}"

- name: Extract all cfzt.cloudflare.com annotations
  ansible.builtin.set_fact:
    cfzt_annotations: "{{ ingressroute.metadata.annotations | dict2items | selectattr('key', 'match', '^cfzt\\.cloudflare\\.com/') | items2dict }}"

- name: Calculate current annotation hash
  ansible.builtin.set_fact:
    current_annotation_hash: "{{ cfzt_annotations | to_json | hash('sha256') }}"

- name: Debug annotation hash
  ansible.builtin.debug:
    msg: |
      IngressRoute: {{ ir_namespace }}/{{ ir_name }}
      Annotation Hash: {{ current_annotation_hash }}
    verbosity: 1

- name: Check if state ConfigMap exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: "{{ state_configmap_name }}"
    namespace: "{{ operator_namespace | default('cloudflare-zero-trust') }}"
  register: state_cm_query

- name: Determine if reconciliation is needed
  ansible.builtin.set_fact:
    needs_reconciliation: "{{ state_cm_query.resources | length == 0 or (state_cm_query.resources[0].data.annotation_hash | default('')) != current_annotation_hash }}"
    stored_annotation_hash: "{{ (state_cm_query.resources[0].data.annotation_hash | default('')) if state_cm_query.resources | length > 0 else '' }}"
    stored_cf_ids: "{{ (state_cm_query.resources[0].data.cloudflare_ids | default('{}') | from_json) if state_cm_query.resources | length > 0 else {} }}"

- name: Debug reconciliation decision
  ansible.builtin.debug:
    msg: |
      ConfigMap exists: {{ state_cm_query.resources | length > 0 }}
      Stored hash: {{ stored_annotation_hash }}
      Current hash: {{ current_annotation_hash }}
      Needs reconciliation: {{ needs_reconciliation }}
    verbosity: 1
