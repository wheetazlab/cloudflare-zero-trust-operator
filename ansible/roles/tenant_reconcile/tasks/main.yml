---
# Main reconciliation logic for a CloudflareZeroTrustTenant
# Variables:
#   - tenant: The CloudflareZeroTrustTenant resource

- name: Set tenant facts
  ansible.builtin.set_fact:
    tenant_name: "{{ tenant.metadata.name }}"
    tenant_namespace: "{{ tenant.metadata.namespace }}"
    tenant_account_id: "{{ tenant.spec.accountId }}"
    tenant_tunnel_id: "{{ tenant.spec.tunnelId }}"
    tenant_zone_id: "{{ tenant.spec.zoneId | default('') }}"
    tenant_credential_ref: "{{ tenant.spec.credentialRef }}"
    tenant_defaults: "{{ tenant.spec.defaults | default({}) }}"

- name: Display reconciliation start
  ansible.builtin.debug:
    msg: "Reconciling tenant: {{ tenant_namespace }}/{{ tenant_name }}"

- name: Get Cloudflare API token from Secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ tenant_credential_ref.name }}"
    namespace: "{{ tenant_namespace }}"
  register: credential_secret

- name: Fail if credential secret not found
  ansible.builtin.fail:
    msg: "Credential secret {{ tenant_credential_ref.name }} not found in namespace {{ tenant_namespace }}"
  when: credential_secret.resources | length == 0

- name: Extract API token
  ansible.builtin.set_fact:
    api_token: "{{ credential_secret.resources[0].data[tenant_credential_ref.key | default('token')] | b64decode }}"

- name: Filter IngressRoutes for this tenant
  ansible.builtin.set_fact:
    tenant_ingressroutes: "{{ cfzt_ingressroutes | selectattr('metadata.namespace', 'equalto', tenant_namespace) | list }}"

- name: Further filter by tenant annotation
  ansible.builtin.set_fact:
    tenant_ingressroutes: "{{ tenant_ingressroutes | selectattr('metadata.annotations.cfzt.cloudflare.com/tenant', 'defined') | selectattr('metadata.annotations.cfzt.cloudflare.com/tenant', 'equalto', tenant_name) | list }}"
  when: tenant_ingressroutes | selectattr('metadata.annotations.cfzt.cloudflare.com/tenant', 'defined') | list | length > 0

- name: Display IngressRoute count for tenant
  ansible.builtin.debug:
    msg: "Found {{ tenant_ingressroutes | length }} IngressRoute(s) for tenant {{ tenant_name }}"

- name: Initialize counters
  ansible.builtin.set_fact:
    count_hostname_routes: 0
    count_access_apps: 0
    count_access_policies: 0
    count_service_tokens: 0

- name: Reconcile each IngressRoute
  include_tasks: reconcile_ingressroute.yml
  loop: "{{ tenant_ingressroutes }}"
  loop_control:
    loop_var: ingressroute
    label: "{{ ingressroute.metadata.namespace }}/{{ ingressroute.metadata.name }}"

- name: Update tenant status
  include_tasks: update_tenant_status.yml
