---
# Update CloudflareZeroTrustTenant status
# Variables:
#   - tenant_name: Tenant name
#   - tenant_namespace: Tenant namespace
#   - count_*: Counters for managed resources

- name: Build status conditions
  ansible.builtin.set_fact:
    status_conditions:
      - type: "Ready"
        status: "True"
        lastTransitionTime: "{{ ansible_date_time.iso8601 }}"
        reason: "ReconcileSuccess"
        message: "Successfully reconciled {{ tenant_httproutes | length }} HTTPRoute(s)"

- name: Build status summary
  ansible.builtin.set_fact:
    status_summary:
      managedHTTPRoutes: "{{ tenant_httproutes | length }}"
      hostnameRoutes: "{{ count_hostname_routes | int }}"
      accessApplications: "{{ count_access_apps | int }}"
      accessPolicies: "{{ count_access_policies | int }}"
      serviceTokens: "{{ count_service_tokens | int }}"

- name: Update CloudflareZeroTrustTenant status
  kubernetes.core.k8s_status:
    api_version: cfzt.cloudflare.com/v1alpha1
    kind: CloudflareZeroTrustTenant
    name: "{{ tenant_name }}"
    namespace: "{{ tenant_namespace }}"
    status:
      observedGeneration: "{{ tenant.metadata.generation }}"
      lastSyncTime: "{{ ansible_date_time.iso8601 }}"
      conditions: "{{ status_conditions }}"
      summary: "{{ status_summary }}"
  register: status_update_result
  failed_when: false

- name: Display status update result
  ansible.builtin.debug:
    msg: "Updated status for tenant {{ tenant_namespace }}/{{ tenant_name }}"
    verbosity: 1
