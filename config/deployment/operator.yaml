apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflare-zero-trust-operator
  namespace: cloudflare-zero-trust
  labels:
    app: cloudflare-zero-trust-operator
    version: v0.1.0
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cloudflare-zero-trust-operator
  template:
    metadata:
      labels:
        app: cloudflare-zero-trust-operator
        version: v0.1.0
    spec:
      serviceAccountName: cloudflare-zero-trust-operator
      containers:
        - name: operator
          image: ghcr.io/wheetazlab/cloudflare-zero-trust-operator:latest
          imagePullPolicy: Always
          env:
            - name: WATCH_NAMESPACES
              value: ""  # Empty = watch all namespaces
            - name: POLL_INTERVAL_SECONDS
              value: "60"
            - name: LOG_LEVEL
              value: "INFO"
            - name: CLOUDFLARE_API_BASE
              value: "https://api.cloudflare.com/client/v4"
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: ansible-tmp
              mountPath: /runner
      volumes:
        - name: tmp
          emptyDir: {}
        - name: ansible-tmp
          emptyDir: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflare-zero-trust-operator-config
  namespace: cloudflare-zero-trust
  labels:
    app: cloudflare-zero-trust-operator
data:
  config.yaml: |
    # Operator configuration
    reconcile:
      interval_seconds: 60
      max_concurrent: 10
    cloudflare:
      api_base: "https://api.cloudflare.com/client/v4"
      rate_limit_retry: 3
      rate_limit_backoff: 5
    logging:
      level: INFO
      format: json
